# action.yml
# witmicko/Appsec-CodeQL@main
name: 'witmicko AppSec CodeQL'
description: 'Run witmicko custom CodeQL analysis'
inputs:
  paths_ignored:
    description: 'Comma-separated list of paths to ignore in scan'
    required: true
  languages: 
    description: 'Languages to scan, an array' 
    required: true
  repo:
    description: 'Repository that requested the scan' 
    required: true
  appsec-codeql-checkout-path: 
    description: 'Path that the Appsec CodeQL repository gets checked into on the action runner'
    required: false
    default: 'appsec-codeql'
    
runs:
  using: 'composite'
  steps:
    - name: List ENV
      run: env
      shell: bash 
      
    - name: Check out Git repository
      uses: actions/checkout@v4
      with:
          path: ${{ inputs.appsec-codeql-checkout-path }}

    - name: List where user is
      run: pwd
      shell: bash 

    - name: List dirs
      run: ls -lia && cd ${{ inputs.repo }} && ls -lia && pwd && cd $GITHUB_WORKSPACE && pwd
      shell: bash 

      
    - name: Enter appsec codeql directory
      run: cd $GITHUB_WORKSPACE/${{ inputs.appsec-codeql-checkout-path }}
      shell: bash 
    - name: Generate Config
        run: |
          cd $GITHUB_WORKSPACE/${{ env.inputs.appsec-codeql-checkout-path }}
          npm i --prod
          node scripts/generate-config.js
      shell: bash 
      env:
        INPUT_PATHS_IGNORED: ${{ inputs.paths_ignored }}
        REPO: ${{inputs.repo}}
        QUERIES: '[{ "name": "Juiceshop qls pack", "uses": "./qls-packs/juiceshop.qls"}]'
        
    - name: Move generated CodeQL Config to the repo we scan
      # $GITHUB_WORKSPACE/${{ inputs.appsec-codeql-checkout-path }}/.github/codeql-config.yml => home/appsec-codeql/.github/codeql-config.yml 
      run: cd $GITHUB_WORKSPACE/${{ inputs.repo }} && mv $GITHUB_WORKSPACE/${{ inputs.appsec-codeql-checkout-path }}/.github/codeql-config.yml ./
      shell: bash 
      
    - name: Initialize CodeQL  
      uses: github/codeql-action/init@v2
      with:
        config-file: ./codeql-config.yml
        languages: ${{ inputs.languages }}
    - name: Run CodeQL Analysis
      id: codeql-analysis
      uses: github/codeql-action/analyze@v2
      with:
        upload: false
    - name: Check outputs
      shell: bash
      run: |
        echo "DB Locations: ${{ steps.codeql-analysis.outputs.db-locations }}"
        echo "SARIF Output: ${{ steps.codeql-analysis.outputs.sarif-output }}"
        echo "SARIF ID: ${{ steps.codeql-analysis.outputs.sarif-id }}"
    - name: Echo SARIF
      shell: bash
      env:
        sarif_file: ${{ steps.codeql-analysis.outputs.sarif-output }}
      run: |
        ls $sarif_file
        cd $sarif_file
        find . -maxdepth 1 -type f -exec cat {} +


    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: ${{ steps.codeql-analysis.outputs.sarif-output }}
        category: metamask-codeql
